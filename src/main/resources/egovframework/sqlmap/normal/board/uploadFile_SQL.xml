<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org//dtd/sql-map-2.dtd">

<sqlMap namespace="uploadFile">
	<!-- 클래스 별칭 정의  -->
	<typeAlias  alias="uploadFileVO" type="egovframework.normal.board.service.UploadFileVO"/>
	
	<!-- 클래스 프로퍼티와 테이블 컬럼 매칭  -->
	<resultMap id="uploadfile" class="egovframework.normal.board.service.UploadFileVO">
		<result property="fileSq" column="file_sq"/>
		<result property="boardNo" column="board_no"/>
		<result property="storeNm" column="store_nm"/>
		<result property="uploadNm" column="upload_nm"/>
		<result property="fileSize" column="file_size"/>
		<result property="fileType" column="file_type"/>
		<result property="useYn" column="use_yn"/>
		<result property="fileNo" column="file_no"/>
	</resultMap>
	
	<!--  첨부파일 추가	-->
	<insert id="uploadFileDAO.insertFile" parameterClass="uploadFileVO">
		<![CDATA[
 			INSERT INTO test_uploadfile_tb  
 				( file_sq 
 				  , board_no 
 				  , store_nm 
 				  , upload_nm 
 				  , file_size 
 				  , file_type
 				  , file_no 
 				   ) 
 			VALUES ( test_uploadfile_seq.nextval 
 				  , #boardNo# 
 				  , #storeNm# 
				  , #uploadNm# 
			      , #fileSize# 
				  , #fileType# 
				  , #fileNo# 
 				  ) 
 		]]> 
		<!--  파일 추가 시 생성되는 파일 아이디 	-->
		<selectKey keyProperty="fileSq"  resultClass="Long">
			SELECT test_uploadFile_seq.currval AS file_sq FROM dual
		</selectKey>
	</insert>
	
	<!--  게시물 첨부파일 목록 조회 	-->
	<select id="uploadFileDAO.selectFileList" parameterClass="uploadFileVO" resultClass="egovMap">
	<![CDATA[
    		   SELECT FILE_NO, FILE_SQ, BOARD_NO, STORE_NM, UPLOAD_NM, 
    		   			  FILE_SIZE, FILE_TYPE, USE_YN 
         	FROM TEST_UPLOADFILE_TB  
         	WHERE  USE_YN = 'Y'
         		AND BOARD_NO = #boardNo#
    	]]> 
    </select>
	
	<!-- 	파일 단건 조회 -->
	<select id="uploadFileDAO.selectFile"  resultMap="uploadfile" remapResults="true">
       	<![CDATA[
             SELECT file_no, file_sq, board_no, 
             			store_nm, upload_nm, file_size, file_type, use_yn
             FROM test_uploadfile_tb  
             WHERE use_yn = 'Y'
             	AND  file_sq =#fileSq# 
         ]]> 
    </select>
    

    <!-- 	파일 단건 삭제 처리  -->
    <delete id="uploadFileDAO.deleteFile">
		<![CDATA[
			UPDATE test_uploadfile_tb
			SET use_yn = 'N'
			WHERE file_sq=#fileSq#
		]]>
	</delete>
	
	<!-- 	파일 전체 삭제 처리  -->
    <delete id="uploadFileDAO.deleteAllFile">
		<![CDATA[	
			UPDATE test_uploadfile_tb
			SET use_yn = 'N'
			WHERE board_no=#boardNo#
		]]>
	</delete>
	
	<!-- 첨부파일 순번 조회 -->
	<select id="uploadFileDAO.selectFileNo" parameterClass="uploadFileVO"  resultClass = "uploadFileVO">
	<![CDATA[	
			SELECT rownum AS file_no, t1.file_sq
			 	FROM (SELECT *
						FROM test_uploadfile_tb
						WHERE 1=1 and use_yn = 'Y'
						 AND BOARD_NO = #boardNo#)t1
	]]>
	</select>
	
	<!-- 첨부파일 순번 수정 -->
	<update id="uploadFileDAO.updateFileNo" parameterClass="uploadFileVO" >
	<![CDATA[	
		UPDATE test_uploadfile_tb
			SET 
				file_no = #fileNo#
			WHERE file_sq = #fileSq#
		]]>
	</update>
	
</sqlMap>
